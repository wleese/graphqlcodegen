<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaFileManifest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GraphQL Code Generator Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">io.github.deweyjose.graphqlcodegen</a> &gt; <span class="el_source">SchemaFileManifest.java</span></div><h1>SchemaFileManifest.java</h1><pre class="source lang-java linenums">package io.github.deweyjose.graphqlcodegen;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.math.BigInteger;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.security.MessageDigest;
import java.util.HashSet;
import java.util.Set;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;
import nu.studer.java.util.OrderedProperties;
import nu.studer.java.util.OrderedProperties.OrderedPropertiesBuilder;

/** Manages a manifest of GraphQL schema files and their checksums for change detection. */
<span class="fc" id="L18">@Slf4j</span>
public class SchemaFileManifest {
  private Set&lt;File&gt; files;
  private final File manifestPath;
  private final File projectPath;

  /**
   * Constructs a SchemaFileManifest with a set of files, manifest path, and project path.
   *
   * @param files the set of schema files
   * @param manifestPath the manifest file path
   * @param projectPath the project base directory
   */
<span class="fc" id="L31">  public SchemaFileManifest(Set&lt;File&gt; files, File manifestPath, File projectPath) {</span>
<span class="fc" id="L32">    this.files = files;</span>
<span class="fc" id="L33">    this.manifestPath = manifestPath;</span>
<span class="fc" id="L34">    this.projectPath = projectPath;</span>
<span class="fc" id="L35">  }</span>

  /**
   * Constructs a SchemaFileManifest with a manifest path and project path.
   *
   * @param manifestPath the manifest file path
   * @param projectPath the project base directory
   */
<span class="fc" id="L43">  public SchemaFileManifest(File manifestPath, File projectPath) {</span>
<span class="fc" id="L44">    this.manifestPath = manifestPath;</span>
<span class="fc" id="L45">    this.projectPath = projectPath;</span>
<span class="fc" id="L46">  }</span>

  /**
   * Generates an MD5 checksum for the given file.
   *
   * @param path the file to checksum
   * @return the checksum as a hex string
   */
<span class="nc" id="L54">  @SneakyThrows</span>
  public static String generateChecksum(File path) {
<span class="fc" id="L56">    byte[] data = Files.readAllBytes(Paths.get(path.toURI()));</span>
<span class="fc" id="L57">    byte[] hash = MessageDigest.getInstance(&quot;MD5&quot;).digest(data);</span>
<span class="fc" id="L58">    String checksum = new BigInteger(1, hash).toString(16);</span>
<span class="fc" id="L59">    return checksum;</span>
  }

  /**
   * Returns true if the file is a GraphQL schema file (.graphql, .graphqls, .gqls).
   *
   * @param file the file to check
   * @return true if the file is a GraphQL schema file
   */
  public static boolean isGraphqlFile(File file) {
<span class="fc bfc" id="L69" title="All 2 branches covered.">    return file.getName().endsWith(&quot;.graphqls&quot;)</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        || file.getName().endsWith(&quot;.graphql&quot;)</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        || file.getName().endsWith(&quot;.gqls&quot;);</span>
  }

  /**
   * Recursively finds all GraphQL schema files in a directory.
   *
   * @param directory the directory to search
   * @return a set of GraphQL schema files
   */
  public static Set&lt;File&gt; findGraphQLSFiles(File directory) {
<span class="fc" id="L81">    Set&lt;File&gt; result = new HashSet&lt;&gt;();</span>

<span class="fc" id="L83">    File[] contents = directory.listFiles();</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">    if (contents != null) {</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">      for (File content : contents) {</span>
<span class="pc bpc" id="L86" title="2 of 4 branches missed.">        if (content.isFile() &amp;&amp; isGraphqlFile(content)) {</span>
<span class="fc" id="L87">          result.add(content);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        } else if (content.isDirectory()) {</span>
<span class="nc" id="L89">          Set&lt;File&gt; subdirectoryGraphQLSFiles = findGraphQLSFiles(content);</span>
<span class="nc" id="L90">          result.addAll(subdirectoryGraphQLSFiles);</span>
        }
      }
    }

<span class="fc" id="L95">    return result;</span>
  }

  /**
   * Sets the files to be tracked by the manifest.
   *
   * @param files the set of files
   */
  public void setFiles(Set&lt;File&gt; files) {
<span class="fc" id="L104">    this.files = files;</span>
<span class="fc" id="L105">  }</span>

  /**
   * Computes the set of files that have changed or are new and need to trigger code generation.
   *
   * @return a set of changed or new files
   */
  public Set&lt;File&gt; getChangedFiles() {
<span class="fc" id="L113">    Set&lt;File&gt; changed = new HashSet&lt;&gt;();</span>
<span class="fc" id="L114">    OrderedProperties manifest = loadManifest();</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">    for (File file : files) {</span>
<span class="fc" id="L116">      String oldChecksum = manifest.getProperty(relativizeToProject(file));</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">      if (oldChecksum == null) {</span>
<span class="fc" id="L118">        log.info(&quot;{} is new, will generate code&quot;, file.getName());</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">      } else if (!oldChecksum.equals(generateChecksum(file))) {</span>
<span class="nc" id="L120">        log.info(&quot;{} has changed, will generate code&quot;, file.getName());</span>
      } else {
<span class="fc" id="L122">        log.info(&quot;{} has not changed, will not generate code&quot;, file.getName());</span>
<span class="fc" id="L123">        continue;</span>
      }
<span class="fc" id="L125">      changed.add(file);</span>
<span class="fc" id="L126">    }</span>
<span class="fc" id="L127">    return changed;</span>
  }

  /**
   * Clears the old manifest, computes new checksums for each file, and saves the properties file.
   */
<span class="pc" id="L133">  @SneakyThrows</span>
  public void syncManifest() {
<span class="fc" id="L135">    OrderedProperties manifest =</span>
<span class="fc" id="L136">        new OrderedPropertiesBuilder().withSuppressDateInComment(true).build();</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">    for (File file : files) {</span>
<span class="fc" id="L138">      manifest.setProperty(relativizeToProject(file), generateChecksum(file));</span>
<span class="fc" id="L139">    }</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">    if (!manifestPath.exists()) {</span>
<span class="fc" id="L142">      manifestPath.getParentFile().mkdirs();</span>
    }

<span class="fc" id="L145">    try (FileOutputStream fos = new FileOutputStream(manifestPath)) {</span>
<span class="fc" id="L146">      manifest.store(fos, &quot;Schema Manifest&quot;);</span>
<span class="fc" id="L147">      fos.flush();</span>
    }
<span class="fc" id="L149">  }</span>

<span class="nc" id="L151">  @SneakyThrows</span>
  private OrderedProperties loadManifest() {
<span class="fc" id="L153">    OrderedProperties properties =</span>
<span class="fc" id="L154">        new OrderedPropertiesBuilder().withSuppressDateInComment(true).build();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">    if (manifestPath.exists()) {</span>
<span class="fc" id="L156">      try (FileInputStream fis = new FileInputStream(manifestPath)) {</span>
<span class="fc" id="L157">        properties.load(fis);</span>
      }
    }
<span class="fc" id="L160">    return properties;</span>
  }

  private String relativizeToProject(File file) {
<span class="fc" id="L164">    return projectPath.toPath().relativize(file.toPath()).toString();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>